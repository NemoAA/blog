## 环境信息

| IP          | 中间件版本                         | port |
| ----------- | ----------------------------- | ---- |
| 10.2.202.73 | FlyingDDM B01C04R for EXCATER | 6432 |

## 1.1 安装信息

```
--安装目录
/home/jboss/FlyingDDM2.0/B01C04R

--日志目录
/home/jboss/FlyingDDM2.0/B01C04R/log

--配置文件目录
/home/jboss/FlyingDDM2.0/B01C04R/conf

--守护脚本
/home/jboss/FlyingDDM2.0/B01C04R/service/flyingddm2_protect.sh

--启动/停止脚本
/home/jboss/start_flyingddm2.sh
/home/jboss/stop_flyingddm2.sh

--监控信息

```

## 1.2 管理

### 1.2.1 启动脚本

> 因为在同一用户下lib不一样,中间件版本不一样故此一脚本方式启动,在脚本中加入lib环境信息,此设置只针对本脚本生效

```
#!/bin/bash
export LD_LIBRARY_PATH=/home/jboss/FlyingDDM1.0/DDM1/lib:$LD_LIBRARY_PATH:/home/jboss/FlyingDDM2.0/B01C04R/Files/third-lib
/home/jboss/FlyingDDM2.0/B01C04R/Files/bin/pgbouncer /home/jboss/FlyingDDM2.0/B01C04R/conf/server.ini -d


```

### 1.2.2 停止脚本

```bash
#!/bin/bash
export LD_LIBRARY_PATH=/home/jboss/FlyingDDM1.0/DDM1/lib:$LD_LIBRARY_PATH:/home/jboss/FlyingDDM2.0/B01C04R/Files/third-lib
kill -9 `cat /home/jboss/FlyingDDM2.0/B01C04R/log/flyingddm.pid`


```

### 1.2.3 守护脚本

```bash
#!/bin/bash
check(){
    NUM=`ps -ef | grep "/home/jboss/FlyingDDM2.0/B01C04R/Files/bin/pgbouncer /home/jboss/FlyingDDM2.0/B01C04R/conf/server.ini"| grep -v grep | wc -l`

    if [ $NUM -lt 1 ] ;
    then
       /home/jboss/stop_flyingddm2.sh
       /home/jboss/start_flyingddm2.sh
    else
       echo 3 >/dev/null 2>&1
    fi
}

while true
do
    check
    sleep 5
done

```

### 1.2.4 配置文件

``` bash
[pgbouncer]

# logfile=/opt/FlyingDDM/B01C04R/log/flyingddm
# csvlog config
# 0: closed  1: open
csvlog=1
# csvlog file path('flyingddm' is prefix name)
csvlog_file = /home/jboss/FlyingDDM2.0/B01C04R/log/flyingddm
#logfile = /home/jboss/FlyingDDM2.0/B01C04R/log/flyingddm.log
pidfile = /home/jboss/FlyingDDM2.0/B01C04R/log/flyingddm.pid


# Logging verbosity. Same as -v switch on command line.
verbose=2

listen_port = 6432
listen_addr = *
pool_mode = transaction
server_check_query = select 1
server_check_delay = 30
group_mode =duplication
admin_users = postgres
auth_type = md5
auth_file = /home/jboss/FlyingDDM2.0/B01C04R/conf/userlist.txt
stats_period = 60
query_wait_timeout=120
server_login_retry=15

max_reqs_persec = 2000
max_client_conn = 5000
default_pool_size = 300
min_pool_size=50

# Monitoring configuration
# 0: off 1: on
monitor_server = 1
monitor_check_delay = 10
monitor_fault_check_delay = 10
minitor_faultcnt = 3
minitor_alivecnt = 3


[groups]
catering = group_mode=replication

[databases]
catering1 = host=10.2.202.77 port=5432 dbname=catering user=postgres group=catering
catering2 = host=10.2.202.80 port=5432 dbname=catering user=postgres readonly=yes max_reqs_persec=1000 group=catering weight=25
catering3 = host=10.2.211.88 port=5432 dbname=catering user=postgres readonly=yes max_reqs_persec=1000 group=catering weight=25
catering4 = host=10.2.211.89 port=5432 dbname=catering user=postgres readonly=yes max_reqs_persec=1000 group=catering weight=25
catering5 = host=10.2.211.90 port=5432 dbname=catering user=postgres readonly=yes max_reqs_persec=1000 group=catering weight=25
```

### 1.2.5 配置项

```bash
pgbouncer=# show config;
            key            |                                value                                 | changeable 
---------------------------+----------------------------------------------------------------------+------------
 job_name                  | pgbouncer                                                            | no
 conffile                  | /home/jboss/FlyingDDM2.0/B01C04R/conf/server.ini                     | yes
 logfile                   |                                                                      | yes
 pidfile                   | /home/jboss/FlyingDDM2.0/B01C04R/log/flyingddm.pid                   | no
 listen_addr               | *                                                                    | no
 listen_port               | 6432                                                                 | no
 listen_backlog            | 128                                                                  | no
 unix_socket_dir           | /tmp                                                                 | no
 unix_socket_mode          | 511                                                                  | no
 unix_socket_group         |                                                                      | no
 auth_type                 | md5                                                                  | yes
 auth_file                 | /home/jboss/FlyingDDM2.0/B01C04R/conf/userlist.txt                   | yes
 auth_hba_file             |                                                                      | yes
 auth_query                | SELECT usename, passwd FROM pg_shadow WHERE usename=$1               | yes
 pool_mode                 | transaction                                                          | yes
 max_client_conn           | 5000                                                                 | yes
 default_pool_size         | 300                                                                  | yes
 min_pool_size             | 50                                                                   | yes
 reserve_pool_size         | 0                                                                    | yes
 reserve_pool_timeout      | 5                                                                    | yes
 max_db_connections        | 0                                                                    | yes
 max_reqs_persec           | 2000                                                                 | yes
 max_user_connections      | 0                                                                    | yes
 syslog                    | 0                                                                    | yes
 syslog_facility           | daemon                                                               | yes
 syslog_ident              | pgbouncer                                                            | yes
 user                      |                                                                      | no
 autodb_idle_timeout       | 3600                                                                 | yes
 server_reset_query        | DISCARD ALL                                                          | yes
 server_reset_query_always | 0                                                                    | yes
 server_check_query        | select 1                                                             | yes
 server_check_delay        | 30                                                                   | yes
 query_timeout             | 0                                                                    | yes
 query_wait_timeout        | 120                                                                  | yes
 client_idle_timeout       | 0                                                                    | yes
 client_login_timeout      | 60                                                                   | yes
 idle_transaction_timeout  | 0                                                                    | yes
 server_lifetime           | 3600                                                                 | yes
 server_idle_timeout       | 600                                                                  | yes
 server_connect_timeout    | 15                                                                   | yes
 server_login_retry        | 15                                                                   | yes
 server_round_robin        | 0                                                                    | yes
 suspend_timeout           | 10                                                                   | yes
 ignore_startup_parameters |                                                                      | yes
 disable_pqexec            | 0                                                                    | no
 dns_max_ttl               | 15                                                                   | yes
 dns_nxdomain_ttl          | 15                                                                   | yes
 dns_zone_check_period     | 0                                                                    | yes
 max_packet_size           | 2147483647                                                           | yes
 pkt_buf                   | 4096                                                                 | no
 sbuf_loopcnt              | 5                                                                    | yes
 tcp_defer_accept          | 1                                                                    | yes
 tcp_socket_buffer         | 0                                                                    | yes
 tcp_keepalive             | 1                                                                    | yes
 tcp_keepcnt               | 0                                                                    | yes
 tcp_keepidle              | 0                                                                    | yes
 tcp_keepintvl             | 0                                                                    | yes
 verbose                   | 2                                                                    | yes
 admin_users               | postgres                                                             | yes
 stats_users               |                                                                      | yes
 stats_period              | 60                                                                   | yes
 stats_pools               | 1                                                                    | yes
 log_connections           | 1                                                                    | yes
 log_disconnections        | 1                                                                    | yes
 log_pooler_errors         | 1                                                                    | yes
 application_name_add_host | 0                                                                    | yes
 client_tls_sslmode        | disable                                                              | no
 client_tls_ca_file        |                                                                      | no
 client_tls_cert_file      |                                                                      | no
 client_tls_key_file       |                                                                      | no
 client_tls_protocols      | all                                                                  | no
 client_tls_ciphers        | fast                                                                 | no
 client_tls_dheparams      | auto                                                                 | no
 client_tls_ecdhcurve      | auto                                                                 | no
 server_tls_sslmode        | disable                                                              | no
 server_tls_ca_file        |                                                                      | no
 server_tls_cert_file      |                                                                      | no
 server_tls_key_file       |                                                                      | no
 server_tls_protocols      | all                                                                  | no
 server_tls_ciphers        | fast                                                                 | no
 monitor_server            | 1                                                                    | yes
 monitor_check_delay       | 10                                                                   | yes
 monitor_fault_check_delay | 10                                                                   | yes
 minitor_faultcnt          | 3                                                                    | yes
 minitor_alivecnt          | 3                                                                    | yes
 csvlog                    | 1                                                                    | yes
 csvlog_file               | /home/jboss/FlyingDDM2.0/B01C04R/log/flyingddm-2017-12-22-111253.csv | yes
(87 rows)

```

