## 1. 归档失败撑爆磁盘空间

### 环境信息

```
Red Hat Enterprise Linux (RHEL) 7.5
PostgreSQL 10.4
```

### 问题

```
归档失败撑爆磁盘空间导致数据库宕机
```

### 根本原因

```
pg_wal/archive_status准备归档的WAL文件已经不存在导致归档失败,WAL堆积至磁盘撑满,数据库宕机
```

### 处理步骤

> 由于线上业务,先手工处理堆积WAL日志

#### 1. 查看控制文件,找到哪些WAL文件是可以清理的

```
su - postgres

[postgres@tk226-nw-f09-x86-jdsjk-01 ~]$ pg_controldata 
pg_control version number:            1002
Catalog version number:               201707211
Database system identifier:           6494504333692061742
Database cluster state:               in production
pg_control last modified:             Mon 10 Dec 2018 11:09:32 PM CST
Latest checkpoint location:           1153/2E107278
Prior checkpoint location:            1149/67FFFEF8
Latest checkpoint's REDO location:    114E/327AFCA8
Latest checkpoint's REDO WAL file:    000000030000114900000067
```

#### 2. 调用`pg_archiveclean`清理WAL日志

```
pg_archivecleanup -d /flyingdata/FlyingDB/pgdata/pg_wal 000000030000114900000067
```

#### 3. 清理`archive_status`目录中相关文件

> 转移12月11号之前所有记录,使归档正常

```
cd $PGDATA/pg_wal/archive_status
ls --time-style=long -htl|grep ^- |awk 'BEGIN{date="2018-12-11"}{if($6<date)print $8}' |xargs -I {} mv {} /flyinglog/wal_archive/bak_archive_status/
```

### 参考

> <http://www.postgres.cn/docs/10/pgarchivecleanup.html>




