## ClickHouse写入抖动分析

### 环境信息

```
Red Hat Enterprise Linux Server release 7.4
ClickHouse-18.14.15
```

### 问题

```
插入在同一服务器上执行有时候快几百ms,有时候慢7-8秒
```

### 根本原因

```
磁盘IO能力不足及内存紧张导致
```

### 诊断步骤

#### 1. 现象

通过分析`top`命令的输出,发现如下两个问题

* 系统iowait升高(观察发现高峰期可达到30%),导致系统平均负载增大,磁盘可能存在瓶颈
* 系统使用了swap,可能存在内存瓶颈

![](https://raw.githubusercontent.com/NemoAA/blog/master/pic/case-analyze-pic/ch-top.png)                                                                                               

接下来我们从磁盘IO和内存两个方面分析系统状态

#### 2. iowait分析

iowait升高,我们来查询系统I/O情况,我们使用`iostat`和`dstat`这两个工具来分析

##### 2.1 dstat

使用`dstat`来查看CPU和I/O的试用情况

![](https://raw.githubusercontent.com/NemoAA/blog/master/pic/case-analyze-pic/ch-dstat.png)

从`dstat`输出可以看出在iowait升高时,磁盘读(read)都会很大,说明iowait的升高和读请求有关,同时通过`pidstat -d 1`可以看出是clickhouse进程导致

##### 2.2 iostat

![](https://raw.githubusercontent.com/NemoAA/blog/master/pic/case-analyze-pic/ch-iostat.png)

同时从`iostat`命令输出也可以看出在,磁盘读非常大导致一直处于100%繁忙状态,同时从clickhouse系统视图中也可以看出,此时正在进行查询

![](https://raw.githubusercontent.com/NemoAA/blog/master/pic/case-analyze-pic/ch-query.png)

```
-- 查看clickhouse正在运行查询命令
watch -n2 "clickhouse-client --query='select address,port,elapsed,query,written_bytes,written_rows,read_bytes,read_rows,memory_usage from system.processes;'"
```

##### 2.3 结论

从上面分析可以看出,磁盘io存在瓶颈,且主要在读操作上

#### 3. 内存分析

下面先看一张内存关系图

![](https://raw.githubusercontent.com/NemoAA/blog/master/pic/case-analyze-pic/memory-info.png)

##### 3.1 sar

通过`sar -r -S 1 10` 命令输出可以看出,系统剩余内存和cache在一个范围内小幅波动,且cache非常大,cache可以使用bcc工具中的cachetop或者cachestat来查看缓存命中率(因为没有root权限,暂时无法查看)

![](https://raw.githubusercontent.com/NemoAA/blog/master/pic/case-analyze-pic/ch-sar.png)

通过/proc/zoneinfo来查看剩余内存,内存阈值,匿名页及文件页的活跃情况

![1547086758277](https://raw.githubusercontent.com/NemoAA/blog/master/pic/case-analyze-pic/ch-swapzone.png)

从上图可以看出剩余内存(pages free)在一个范围内不停的波动,当他低于页低阈值(min)值时,又会增大到高于页高阈值(high),同时结合sar观察结果可以推出,剩余内存和缓层的变化是由于内存紧张产生内存回收和缓存再次分配的结果

使用下面脚本对按 VmSwap 使用量对进程排序,输出进程名称,进程ID以及SWAP用量

```
[clickhouse@tk107-ww-b05-dx1-14 ~]$ for file in /proc/*/status ; do awk '/VmSwap|Name|^Pid/{printf $2 " " $3}END{ print ""}' $file; done | sort -k 3 -n -r | head
clickhouse-serv 20495 168728 kB
python 30486 13316 kB
tuned 1677 10484 kB
polkitd 1147 9708 kB
python 30494 9324 kB
systemd 1 3060 kB
abrtd 1155 1848 kB
systemd-udevd 808 1608 kB
abrt-watch-log 1157 1388 kB
rsyslogd 1140 1116 kB
```

##### 3.2 结论

从上面可以看出在进行大查询的时候,系统内存页非常紧张

#### 4. 建议

* 1. 增加磁盘能力
  2. 调低clickhouse单个查询使用的内存